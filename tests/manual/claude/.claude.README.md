# Claude Code MCP Configuration

This directory contains `.mcp.json` configuration file for connecting Claude Code to MCP Obsidian server.

## Quick Start

### 1. Enable DIRENV

The project uses [DIRENV](https://direnv.net/) to automatically load environment variables. DIRENV loads variables from `.envrc` when you enter the project directory.

### 2. Update API Key in `.mcp.json`

Edit `.mcp.json` and replace `your-obsidian-api-key-here` with your actual API key.

### 3. Enable Desired Configuration

Set `"disabled": false` for the server configuration you want to use.

## Available Configurations

### `obsidian-stdio-local` (default, enabled)

Runs MCP Obsidian server from source code using Bun. This is the default configuration for local development.

**Environment variables** (loaded from `.envrc`):

- `API_KEY` - Obsidian Local REST API key
- `API_HOST` - Obsidian REST API host (WSL2 gateway or localhost)
- `API_PORT` - Obsidian REST API port (27124)

**Best for:**

- Local development with hot reload
- Testing and debugging
- WSL2 environments

### `obsidian-docker-http` (disabled)

Connects to Docker-hosted MCP Obsidian server via HTTP transport.

**Configuration:**

```json
{
  "type": "http",
  "url": "http://localhost:3000/mcp",
  "timeout": 30000
}
```

**Prerequisites:**

1. Build Docker image: `bun run docker:latest`
2. Start Docker container with HTTP transport:

  ```bash
  docker run --name mcp-obsidian --rm -i \
    --network=host \
    -e MCP_TRANSPORTS=http \
    -e MCP_HTTP_PORT=3000 \
    -e API_KEY=$API_KEY \
    -e API_HOST=$API_HOST \
    -e API_PORT=$API_PORT \
    mcp/obsidian:latest
  ```

**Best for:**

- Isolated server environment
- Production deployments
- Team development

### `obsidian-docker-http-auth` (disabled)

Connects to Docker-hosted MCP Obsidian server via HTTP transport with Bearer token authentication.

**Configuration:**

```json
{
  "type": "http",
  "url": "http://localhost:3000/mcp",
  "headers": {
    "Authorization": "Bearer your-token-here"
  },
  "timeout": 30000
}
```

**Best for:**

- Remote server access with authentication
- Production deployments with API tokens
- Team projects with secured endpoints

## Environment Variables

DIRENV automatically loads these variables from `.envrc` when entering the project directory:

```bash
export API_KEY      # From .secrets/obsidian_local_rest_api_key
export API_HOST      # WSL2 gateway or localhost
export API_PORT      # Default: 27124
export WSL_GATEWAY_IP  # For WSL2 access to Windows host
```

## Docker MCP Server Quick Start

### Start Docker Server with HTTP Transport

```bash
# 1. Set environment variables (or rely on DIRENV)
export API_KEY="your-obsidian-api-key"
export API_HOST="https://172.26.32.1"
export API_PORT="27124"

# 2. Start Docker container with HTTP transport
docker run --name mcp-obsidian --rm -i \
  --network=host \
  -e MCP_TRANSPORTS=http \
  -e MCP_HTTP_PORT=3000 \
  -e API_KEY=$API_KEY \
  -e API_HOST=$API_HOST \
  -e API_PORT=$API_PORT \
  mcp/obsidian:latest

# 3. Verify server is running
curl http://localhost:3000/health
```

### Test Docker HTTP Server

```bash
# Test health endpoint
curl http://localhost:3000/health

# List available MCP tools
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'
```

## Usage Examples

### Example 1: Connect to local stdio server

```json
{
  "mcpServers": {
    "obsidian-stdio-local": {
      "disabled": false
    }
  }
}
```

### Example 2: Connect to Docker HTTP server

```json
{
  "mcpServers": {
    "obsidian-docker-http": {
      "disabled": false
    }
  }
}
```

### Example 3: Connect to Docker HTTP server with authentication

```json
{
  "mcpServers": {
    "obsidian-docker-http-auth": {
      "disabled": false
    }
  }
}
```

## Troubleshooting

### Claude Code doesn't load MCP servers

1. **Check .mcp.json location:** Must be in project root directory
2. **Validate JSON:** Ensure JSON is valid (no trailing commas, proper quoting)
3. **Check environment variables:** Verify API_KEY is set: `echo $API_KEY`
4. **Restart Claude Code:** Close and reopen Claude Code after changing configuration

### Docker connection errors

1. **Verify Docker is running:** `docker ps`
2. **Check container logs:** `docker logs mcp-obsidian`
3. **Test connectivity:** `curl http://localhost:3000/health`
4. **Verify port binding:** Ensure MCP_HTTP_PORT matches Docker port mapping

### WSL2 connectivity issues

1. **Check WSL_GATEWAY_IP:** `echo $WSL_GATEWAY_IP`
2. **Test Obsidian API:** `curl -k https://$WSL_GATEWAY_IP:27124`
3. **Use host networking:** `--network=host` flag for Docker containers

## Additional Resources

- [Claude Code MCP Documentation](https://code.claude.com/docs/en/mcp)
- [MCP Obsidian Server Documentation](./docs/04_manual_testing.md)
- [E2E Verification Guide](./docs/05_e2e_verification.md)
- [DIRENV Setup Guide](./docs/06_direnv_setup.md)
