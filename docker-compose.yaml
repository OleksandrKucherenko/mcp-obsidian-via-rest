# Plugin: https://github.com/coddingtonbear/obsidian-local-rest-api
# Obsidian: https://github.com/obsidianmd/obsidian-releases
# Docker: https://github.com/linuxserver/docker-obsidian
# Beta Reviewer's Auto-update Tool: https://tfthacker.com/BRAT

services:
  obsidian:
    networks:
      - vnc-net
    build:
      context: ./dockerize
      dockerfile: Dockerfile
      args:
        - IMAGE_NAME=obsidian-vnc
        - IMAGE_TAG=latest
    container_name: obsidian-vnc
    environment:
      - PUID=1000 # You might want to remove PUID/PGID if not used by your custom image's entrypoint
      - PGID=1000 # Or ensure your entrypoint.sh respects them if needed
      - VNC_PASSWORD=yoursecurepassword # Set VNC password here
    volumes:
      # vault data
      - ./dockerize/obsidian/data:/config/obsidian
      # application global settings
      - ./dockerize/obsidian/.config/obsidian:/home/appuser/.config/obsidian
    ports:
      - "5900:5900" # For VNC
      - "27124:27124" # For Obsidian Local REST API
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-check-certificate", "-S", "https://127.0.0.1:27124", "-O", "/dev/null", "-q" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-obsidian
    networks:
      - vnc-net
    depends_on:
      obsidian:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "3000:3000" # HTTP transport port
    environment:
      - DEBUG=mcp:*
      # Enable HTTP transport
      - MCP_TRANSPORTS=http,stdio
      - MCP_HTTP_PORT=3000
      - MCP_HTTP_HOST=0.0.0.0
      - MCP_HTTP_PATH=/mcp
      # Configure Obsidian API connection (points to obsidian service)
      - API_HOST=https://obsidian
      - API_PORT=27124
      # API_KEY must be provided (set in .env or via docker run)
      # - API_KEY=your-api-key-here
      # Uncomment to enable authentication
      # - MCP_HTTP_TOKEN=your-secret-token
    healthcheck:
      # Use HTTP endpoint for health check (HTTP transport is enabled)
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  vnc-net:
    driver: bridge
