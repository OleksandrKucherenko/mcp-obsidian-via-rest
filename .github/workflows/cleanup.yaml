name: Maintenance

on:
  # Weekly schedule for version cleanup
  schedule:
    - cron: '0 2 * * 0'  # Runs at 2:00 AM every Sunday
  workflow_dispatch:
    inputs:
      run_cleanup:
        description: 'Run cleanup-old-npm-versions job'
        type: boolean
        default: true
      run_docker_cleanup:
        description: 'Run cleanup-old-docker-images job'
        type: boolean
        default: true
      run_branch_cleanup:
        description: 'Run cleanup-old-release-branches job'
        type: boolean
        default: true
      run_pr_screenshots_cleanup:
        description: 'Run cleanup-pr-screenshots job'
        type: boolean
        default: true
      branch_cleanup_days:
        description: 'Days threshold for release branch cleanup'
        type: number
        default: 7

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # Cleanup job to deprecate old versions (runs weekly)
  cleanup-old-npm-versions:
    if: |
      ${{ 
        ( github.event_name == 'schedule' ) ||
        ( github.event.inputs.run_cleanup == true )
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org/'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install required tools
        run: |
          # TODO: reserved for future installations
          bun install

      - name: Get package name
        id: pkg-info
        run: |
          PKG_NAME=$(jq -r '.name' package.json)
          echo "PKG_NAME=${PKG_NAME}" >> $GITHUB_OUTPUT
          NORMALIZED_PKG_NAME=$(echo "${PKG_NAME}" | tr '[:upper:]' '[:lower:]')
          echo "NORMALIZED_PKG_NAME=${NORMALIZED_PKG_NAME//\//-}" >> $GITHUB_OUTPUT

      - name: Deprecate old package versions
        run: |
          echo "Running automated NPM package deprecation"
          node ./assets/ci_cleanup_npm_package.js "${{ steps.pkg-info.outputs.PKG_NAME }}"

          # print the generated script
          if [ -f ./deprecate-${{ steps.pkg-info.outputs.NORMALIZED_PKG_NAME }}-old-versions.sh ]; then
            ./deprecate-${{ steps.pkg-info.outputs.NORMALIZED_PKG_NAME }}-old-versions.sh | tee
          else
            echo "No script for execution found"
            ls -la
          fi
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
          # used in .npmrc file
          NPMRC_GITHUB_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
          NPMRC_DEFAULT_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
          NPM_REGISTRY_URL: "https://registry.npmjs.org/"

  # Cleanup job to delete old Docker images (runs weekly)
  cleanup-old-docker-images:
    if: |
      ${{ 
        ( github.event_name == 'schedule' ) ||
        ( github.event.inputs.run_docker_cleanup == true )
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Set lowercase repository name
        id: repo_name
        run: |
          # Extract owner and repo name
          echo "owner=$(echo ${GITHUB_REPOSITORY} | cut -d '/' -f 1 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "repo_simple=$(echo ${GITHUB_REPOSITORY} | cut -d '/' -f 2 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Cleanup old obsidian-vnc Docker images
        run: |
          echo "Running automated Docker image cleanup for obsidian-vnc"
          node ./assets/ci_cleanup_docker_images.js "${{ steps.repo_name.outputs.owner }}" "obsidian-vnc" --force

          # Print the generated script
          if [ -f ./cleanup-docker-${{ steps.repo_name.outputs.owner }}-obsidian-vnc-old-images.sh ]; then
            echo "Generated cleanup script for obsidian-vnc:"
            ./cleanup-docker-${{ steps.repo_name.outputs.owner }}-obsidian-vnc-old-images.sh | tee
          else
            echo "No cleanup script for obsidian-vnc found"
            ls -la
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old obsidian-mcp Docker images
        run: |
          echo "Running automated Docker image cleanup for obsidian-mcp"
          node ./assets/ci_cleanup_docker_images.js "${{ steps.repo_name.outputs.owner }}" "obsidian-mcp" --force

          # Print the generated script
          if [ -f ./cleanup-docker-${{ steps.repo_name.outputs.owner }}-obsidian-mcp-old-images.sh ]; then
            echo "Generated cleanup script for obsidian-mcp:"
            ./cleanup-docker-${{ steps.repo_name.outputs.owner }}-obsidian-mcp-old-images.sh | tee
          else
            echo "No cleanup script for obsidian-mcp found"
            ls -la
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Cleanup job to delete old release branches (runs weekly)
  cleanup-old-release-branches:
    if: |
      ${{
        ( github.event_name == 'schedule' ) ||
        ( github.event.inputs.run_branch_cleanup == true )
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Cleanup old release branches
        run: |
          DAYS="${{ github.event.inputs.branch_cleanup_days || 7 }}"
          node ./assets/ci_cleanup_release_branches.js --days $DAYS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Execute cleanup script
        if: hashFiles('cleanup-release-branches-*.sh') != ''
        run: |
          LATEST_SCRIPT=$(ls -t cleanup-release-branches-*.sh | head -n1)
          ./$LATEST_SCRIPT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Cleanup job to delete PR screenshot directories for closed PRs
  cleanup-pr-screenshots:
    if: |
      ${{
        ( github.event_name == 'schedule' ) ||
        ( github.event.inputs.run_pr_screenshots_cleanup == true )
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout screenshots branch
        uses: actions/checkout@v4
        with:
          ref: screenshots
          fetch-depth: 1
        continue-on-error: true

      - name: Cleanup closed PR screenshots
        if: success()
        run: |
          # Get list of open PRs
          OPEN_PRS=$(gh pr list --state open --json number --jq '.[].number' | tr '\n' ' ')
          echo "Open PRs: ${OPEN_PRS:-none}"

          # Find all pr-* directories
          CLEANED=0
          for pr_dir in pr-*; do
            if [ -d "$pr_dir" ]; then
              PR_NUM="${pr_dir#pr-}"

              # Check if PR is still open
              if echo " $OPEN_PRS " | grep -q " $PR_NUM "; then
                echo "Keeping $pr_dir (PR #$PR_NUM is open)"
              else
                echo "Removing $pr_dir (PR #$PR_NUM is closed/merged)"
                rm -rf "$pr_dir"
                CLEANED=$((CLEANED + 1))
              fi
            fi
          done

          echo "Cleaned up $CLEANED PR screenshot directories"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push cleanup
        if: success()
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: cleanup closed PR screenshots"
            git push origin screenshots
            echo "âœ“ Cleanup committed and pushed"
          else
            echo "No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
