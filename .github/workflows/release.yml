name: Release

run-name: "${{ inputs.dry_run && 'Dry-run' || 'Release' }}: ${{ inputs.custom_version || (inputs.version_bump == 'auto' && inputs.prerelease == '<stable>' && 'auto (conventional)' || format('{0} â†’ {1}', inputs.version_bump, inputs.prerelease)) }}"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual release)'
        type: boolean
        default: false
      version_bump:
        description: 'Version bump type: auto = conventional commits, or major/minor/patch (ignored if custom_version is set)'
        type: choice
        options: [auto, major, minor, patch]
        default: auto
      prerelease:
        description: 'Pre-release identifier (alpha, beta, rc) - creates pre-release'
        type: choice
        options: ['<stable>', alpha, beta, rc]
        default: '<stable>'
      custom_version:
        description: 'Custom version (e.g., 0.6.0, 0.7.0-beta.1) - overrides version_bump'
        type: string
        required: false

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.checks.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Typecheck
        run: bun run checks:types

      - name: Lint
        run: bun run checks:lint

      - name: Unit tests
        run: bun test

      - name: Build package
        run: bun run build

      - name: Set release flag
        id: checks
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "::notice::Dry run mode - will skip actual release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Calculate version (dry run)
        id: version
        run: |
          BUMP="${{ inputs.version_bump }}"
          CUSTOM_VERSION="${{ inputs.custom_version }}"
          PRERELEASE="${{ inputs.prerelease }}"

          # Treat <stable> as empty (stable release)
          if [ "$PRERELEASE" == "<stable>" ]; then
            PRERELEASE=""
          fi

          if [ -n "$CUSTOM_VERSION" ]; then
            # Custom version specified - use as-is
            VERSION="$CUSTOM_VERSION"
            echo "::notice::Using custom version: ${VERSION}"
          else
            # Build release-it arguments
            if [ "$BUMP" == "auto" ]; then
              # Auto mode: let release-it determine version from conventional commits
              VERSION_ARGS=""
              echo "::notice::Auto mode: determining version from conventional commits"
            else
              # Manual bump mode
              VERSION_ARGS="$BUMP"
              echo "::notice::Manual bump: $BUMP"
            fi

            if [ -n "$PRERELEASE" ]; then
              VERSION_ARGS="$VERSION_ARGS --preRelease=$PRERELEASE"
              echo "::notice::Pre-release mode: $PRERELEASE"
            fi

            # Calculate version using release-it
            VERSION=$(bun run release-it --config .release-it.ci.jsonc $VERSION_ARGS --dry-run --ci --release-version 2>&1 | grep -E '^[0-9]+\.[0-9]+\.[0-9]+')
          fi
          
          if [ -z "$VERSION" ]; then
            echo "::error::Failed to calculate version"
            exit 1
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT
          echo "::notice::Calculated version: ${VERSION}"

  create-release:
    needs: pre-flight
    if: needs.pre-flight.outputs.should_release == 'true' || inputs.dry_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Create and checkout release branch
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          echo "Creating release branch: release/v${VERSION}"
          git checkout -b release/v${VERSION}
          git push -u origin release/v${VERSION}

      - name: Run release-it
        run: |
          BUMP="${{ inputs.version_bump }}"
          CUSTOM_VERSION="${{ inputs.custom_version }}"
          PRERELEASE="${{ inputs.prerelease }}"
          DRY_RUN="${{ inputs.dry_run }}"

          # Treat <stable> as empty (stable release)
          if [ "$PRERELEASE" == "<stable>" ]; then
            PRERELEASE=""
          fi

          # Build version arguments
          if [ -n "$CUSTOM_VERSION" ]; then
            VERSION_ARG="$CUSTOM_VERSION"
            echo "Using custom version: $VERSION_ARG"
          else
            if [ "$BUMP" == "auto" ]; then
              # Auto mode: let release-it determine version from conventional commits
              VERSION_ARG=""
              echo "Auto mode: determining version from conventional commits"
            else
              # Manual bump mode
              VERSION_ARG="$BUMP"
              echo "Manual bump: $BUMP"
            fi

            if [ -n "$PRERELEASE" ]; then
              VERSION_ARG="$VERSION_ARG --preRelease=$PRERELEASE"
              echo "Pre-release mode: $PRERELEASE"
            fi
          fi
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "=== DRY RUN MODE ==="
            echo "Calculated version: ${{ needs.pre-flight.outputs.version }}"
            echo "Pre-release: ${PRERELEASE:-none}"
            echo "Running release-it in dry-run mode..."
            bun run release-it --config .release-it.ci.jsonc $VERSION_ARG --dry-run --ci
            echo ""
            echo "=== DRY RUN COMPLETE ==="
            echo "No changes made to repository"
          else
            echo "=== CREATING RELEASE ==="
            echo "Version: ${{ needs.pre-flight.outputs.version }}"
            echo "Bump type: $BUMP"
            echo "Pre-release: ${PRERELEASE:-none}"
            echo ""
            bun run release-it --config .release-it.ci.jsonc $VERSION_ARG --ci
            echo ""
            echo "=== RELEASE COMPLETE ==="
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger downstream workflows
        if: inputs.dry_run != true && inputs.dry_run != 'true'
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          TAG="v${VERSION}"

          echo "Triggering downstream workflows for tag: ${TAG}"

          # Trigger NPM (npmjs.org) workflow
          echo "Triggering NPM (npmjs.org) workflow..."
          gh workflow run npm-npmjs.yml --ref "${TAG}"
          echo "âœ… NPM (npmjs.org) workflow triggered"

          # Trigger Docker (GitHub/GHCR) workflow
          echo "Triggering Docker (GHCR) workflow..."
          gh workflow run docker-github.yml --ref "${TAG}"
          echo "âœ… Docker (GHCR) workflow triggered"

          # Trigger Docker (Docker Hub) workflow - only for stable releases
          PRERELEASE="${{ inputs.prerelease }}"
          if [ "$PRERELEASE" == "<stable>" ]; then
            echo "Triggering Docker (Docker Hub) workflow..."
            gh workflow run docker-hub.yml --ref "${TAG}"
            echo "âœ… Docker (Docker Hub) workflow triggered"
          else
            echo "â„¹ï¸ Skipping Docker (Docker Hub) - pre-release detected"
          fi

          echo ""
          echo "All workflows triggered successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: inputs.dry_run != true && inputs.dry_run != 'true'
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch:** release/v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [npm Package](https://www.npmjs.com/package/@oleksandrkucherenko/mcp-obsidian/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The following workflows have been triggered:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NPM (npmjs.org)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker (GitHub/GHCR)" >> $GITHUB_STEP_SUMMARY
          PRERELEASE="${{ inputs.prerelease }}"
          if [ "$PRERELEASE" == "<stable>" ]; then
            echo "- âœ… Docker (Docker Hub)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸  Docker (Docker Hub) - **Skipped for pre-release**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor workflows at: https://github.com/${{ github.repository }}/actions" >> $GITHUB_STEP_SUMMARY

      - name: Dry run summary
        if: inputs.dry_run == 'true'
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          PRERELEASE="${{ inputs.prerelease }}"

          # Treat <stable> as empty (stable release)
          if [ "$PRERELEASE" == "<stable>" ]; then
            PRERELEASE=""
          fi

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          COMMIT_COUNT=$(git rev-list ${LATEST_TAG}..HEAD --count 2>/dev/null || echo "0")
          
          echo "## ðŸ” Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current version | \`${LATEST_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Next version** | \`v${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits since release | ${COMMIT_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump type | ${{ inputs.version_bump }} |" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PRERELEASE" ]; then
            echo "| Pre-release | \`${PRERELEASE}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log ${LATEST_TAG}..HEAD --oneline --no-decorate 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || echo "No commits found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To create actual release:" >> $GITHUB_STEP_SUMMARY
          echo "1. Re-run this workflow without 'Dry run' enabled" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PRERELEASE" ]; then
            echo "   \`gh workflow run release.yml -f version_bump=${{ inputs.version_bump }} -f prerelease=${PRERELEASE}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "   \`gh workflow run release.yml -f version_bump=${{ inputs.version_bump }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "2. Monitor workflows triggered by tag creation" >> $GITHUB_STEP_SUMMARY
