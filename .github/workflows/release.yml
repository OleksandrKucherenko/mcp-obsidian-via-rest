name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        type: choice
        options: [major, minor, patch]
        default: patch
      dry_run:
        description: 'Dry run mode (no actual release)'
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  pre-flight:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.checks.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Typecheck
        run: bun run checks:types

      - name: Lint
        run: bun run checks:lint

      - name: Unit tests
        run: bun test

      - name: Build package
        run: bun run build

      - name: Set release flag
        id: checks
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "::notice::Dry run mode - will skip actual release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Calculate version (dry run)
        id: version
        run: |
          BUMP="${{ inputs.version_bump }}"
          VERSION=$(bun run release-it --config .release-it.release-branch.jsonc $BUMP --dry-run --ci --release-version 2>&1 | grep -E '^\d+\.\d+\.\d+$')
          if [ -z "$VERSION" ]; then
            echo "Failed to calculate version"
            exit 1
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "::notice::Calculated version: ${VERSION}"

  create-release:
    needs: pre-flight
    if: needs.pre-flight.outputs.should_release == 'true' || inputs.dry_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Create and checkout release branch
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          echo "Creating release branch: release/v${VERSION}"
          git checkout -b release/v${VERSION}

      - name: Run release-it
        run: |
          BUMP="${{ inputs.version_bump }}"
          DRY_RUN="${{ inputs.dry_run }}"

          if [ "$DRY_RUN" == "true" ]; then
            echo "=== DRY RUN MODE ==="
            echo "Calculated version: ${{ needs.pre-flight.outputs.version }}"
            echo "Running release-it in dry-run mode..."
            bun run release-it --config .release-it.release-branch.jsonc $BUMP --dry-run --ci
            echo ""
            echo "=== DRY RUN COMPLETE ==="
            echo "No changes made to repository"
          else
            echo "=== CREATING RELEASE ==="
            echo "Version: ${{ needs.pre-flight.outputs.version }}"
            echo "Bump type: $BUMP"
            echo ""
            bun run release-it --config .release-it.release-branch.jsonc $BUMP --ci
            echo ""
            echo "=== RELEASE COMPLETE ==="
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        if: inputs.dry_run == 'false'
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch:** release/v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [npm Package](https://www.npmjs.com/package/@oleksandrkucherenko/mcp-obsidian/v/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The following workflows are now triggered:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ NPM (npmjs.org)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docker (GitHub/GHCR)" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️  Docker (Docker Hub) - **Manual trigger required**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor workflows at: https://github.com/${{ github.repository }}/actions" >> $GITHUB_STEP_SUMMARY

      - name: Dry run summary
        if: inputs.dry_run == 'true'
        run: |
          VERSION="${{ needs.pre-flight.outputs.version }}"
          echo "## Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Calculated Version" >> $GITHUB_STEP_SUMMARY
          echo "**${VERSION}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To create actual release:" >> $GITHUB_STEP_SUMMARY
          echo "1. Re-run this workflow without 'Dry run' enabled" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor workflows triggered by tag creation" >> $GITHUB_STEP_SUMMARY
