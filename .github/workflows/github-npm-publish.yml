name: Publish NPM Package (GitHub)

on:
  release:
    types: [created]
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (optional)'
        required: false
        type: string

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
# concurrency:
#   group: "pages"
#   cancel-in-progress: false

jobs: 
  # Multi-platform unit testing
  testing-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env

      - name: Run Type Checks
        run: |
          bun add --peer typescript
          bun run checks:types

      - name: Run Linting
        run: |
          bun run checks:lint

      - name: Run Knip
        run: |
          bun run checks:knip

      - name: Run Unit Tests
        run: bun run test

      - name: Build Package
        run: bun run build

  # E2E testing with manual Docker management (Linux only)
  testing-e2e-manual:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux-x86
          - os: macos-latest
            platform: macos-arm64
    runs-on: ${{ matrix.os }}
    name: E2E Tests (${{ matrix.os }})
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env

      - name: Start Docker Compose for E2E Tests
        id: compose-e2e
        uses: hoverkraft-tech/compose-action@v2.2.0
        with:
          compose-file: ./docker-compose.yaml
          up-flags: "-d"

      - name: Wait for Services
        run: |
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Run E2E Tests (Manual Docker Management)
        env:
          API_KEY: "190ba65d28ac1ba4797cb195bb06f20965395abbd9c39a0fa9b6cab2345c58b9"
        run: |
          echo "Running E2E tests with Docker Compose managed containers"
          bun run test:e2e

  # Container testing with testcontainers (automated lifecycle)
  testing-containers-automated:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux-x86
          - os: macos-latest
            platform: macos-arm64
    runs-on: ${{ matrix.os }}
    name: TestContainers (${{ matrix.os }})
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env

      - name: Run Container Tests (Testcontainers)
        run: |
          echo "Running container tests with testcontainers (automated lifecycle)"
          bun run test:containers
        
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs:
      - testing-unit
      - testing-e2e-manual
      - testing-containers-automated
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-env

      - name: Extract Release Type (semantic commit)
        id: release-type
        continue-on-error: true
        run: |
          # Check release-it for next version based on commits between last tag and HEAD.
          bun run release:dry --ci --no-increment

          # Update package.json
          jq ".version = \"${{ steps.repo_name.outputs.sha_version }}\"" package.json > package.tmp.json
          mv package.tmp.json package.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Package
        run: |
          # prepare the TGZ file for publishing
          bun run publish:prepare

      - name: Publish to GitHub Packages
        run: |
          # do the publishing under unique 'sha-${SHA}' tag
          bun publish --tag ${{ steps.repo_name.outputs.tag }} --registry "https://npm.pkg.github.com"
        env:
          BUN_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # used in .npmrc, .envrc and .bunfig.toml
          GITHUB_NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPMJS_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_REGISTRY_URL: "https://npm.pkg.github.com"
