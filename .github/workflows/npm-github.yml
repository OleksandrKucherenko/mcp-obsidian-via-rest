# Publish NPM Package to GitHub Packages (Staging Environment)
# Triggers on PRs (with SHA-versioned packages) and version tags
name: NPM (npm.pkg.github.com)

on:
  pull_request:
    branches: [main]
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (optional)'
        required: false
        type: string

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # Run tests in parallel
  testing-e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Docker Compose
        id: compose
        uses: hoverkraft-tech/compose-action@v2.2.0
        continue-on-error: true
        with:
          compose-file: ./docker-compose.yaml

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Run E2E Tests
        continue-on-error: true
        env:
          # this is docker image API key
          API_KEY: "190ba65d28ac1ba4797cb195bb06f20965395abbd9c39a0fa9b6cab2345c58b9"
        run: |
          bun run test:e2e

  testing-containers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Docker Compose
        id: compose
        uses: hoverkraft-tech/compose-action@v2.2.0
        continue-on-error: true
        with:
          compose-file: ./docker-compose.test.yaml

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Run E2E Tests
        continue-on-error: true
        run: |
          bun run test:containers

  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write
    needs:
      - testing-e2e
      - testing-containers
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set lowercase repository name
        id: repo_name
        run: |
          # Extract owner and repo name
          echo "owner=$(echo ${GITHUB_REPOSITORY} | cut -d '/' -f 1 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "repo_simple=$(echo ${GITHUB_REPOSITORY} | cut -d '/' -f 2 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          registries: |
            @oleksandrkucherenko=https://npm.pkg.github.com

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          registry-url: https://npm.pkg.github.com/
          scope: '@${{ steps.repo_name.outputs.owner }}'

      - name: Install Dependencies
        run: bun install

      - name: Run Unit Tests
        run: |
          # run unit tests
          bun run test

      - name: Determine package version
        id: version
        run: |
          BASE_VERSION=$(jq -r '.version' package.json)

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR build: use SHA hash as semver pre-release (not build metadata)
            # Note: npm strips build metadata (+), but preserves pre-release (-)
            # Format: 0.6.0-sha.abc1234
            SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            PACKAGE_VERSION="${BASE_VERSION}-sha.${SHORT_SHA}"
            NPM_TAG="sha-${SHORT_SHA}"
            echo "::notice::PR build - Version: ${PACKAGE_VERSION}, Tag: ${NPM_TAG}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Tag build: use tag version
            PACKAGE_VERSION="${GITHUB_REF#refs/tags/v}"
            NPM_TAG="latest"
            echo "::notice::Tag build - Version: ${PACKAGE_VERSION}, Tag: ${NPM_TAG}"
          else
            # Manual/other: use SHA hash as pre-release
            SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
            PACKAGE_VERSION="${BASE_VERSION}-sha.${SHORT_SHA}"
            NPM_TAG="dev"
            echo "::notice::Dev build - Version: ${PACKAGE_VERSION}, Tag: ${NPM_TAG}"
          fi

          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "NPM_TAG=${NPM_TAG}" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=${BASE_VERSION}" >> $GITHUB_OUTPUT

      - name: Check if version already published to GitHub Packages
        id: check-published
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.PACKAGE_VERSION }}"
          PACKAGE_SCOPE="@oleksandrkucherenko"
          PACKAGE_NAME="mcp-obsidian"
          FULL_NAME="${PACKAGE_SCOPE}/${PACKAGE_NAME}"

          echo "Checking if ${FULL_NAME}@${PACKAGE_VERSION} is already published to GitHub Packages..."

          # Check if package version exists in GitHub Packages registry
          if npm view "${FULL_NAME}@${PACKAGE_VERSION}" --registry "https://npm.pkg.github.com" > /dev/null 2>&1; then
            echo "::notice::Version ${PACKAGE_VERSION} is already published to GitHub Packages"
            echo "ALREADY_PUBLISHED=true" >> $GITHUB_OUTPUT
          else
            echo "::notice::Version ${PACKAGE_VERSION} is not yet published to GitHub Packages"
            echo "ALREADY_PUBLISHED=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify that Package is ready for GitHub Packages
        run: |
          # Ensure package.json has correct repository field
          if ! grep -q '"repository"' package.json; then
            sed -i 's/^\(  "name": ".*"\)/\1,\n  "repository": "https:\/\/github.com\/${{ github.repository }}"/g' package.json
          fi

          # Make sure package name is scoped
          if ! grep -q '"name": "@' package.json; then
            PACKAGE_NAME=$(node -p "require('./package.json').name")
            sed -i "s/\"name\": \"$PACKAGE_NAME\"/\"name\": \"@${{ github.repository_owner }}\/$(echo $PACKAGE_NAME | sed 's/@.*\///')\"/g" package.json
          fi

      - name: Update package.json version
        if: steps.check-published.outputs.ALREADY_PUBLISHED != 'true'
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.PACKAGE_VERSION }}"
          jq ".version = \"$PACKAGE_VERSION\"" package.json > package.tmp.json
          mv package.tmp.json package.json
          echo "Updated package.json version to ${PACKAGE_VERSION}"

      - name: Build Package
        if: steps.check-published.outputs.ALREADY_PUBLISHED != 'true'
        run: |
          # prepare TGZ file for publishing
          bun run publish:prepare

      - name: Publish to GitHub Packages
        # Skip for forked PRs (no secrets/packages:write permission)
        if: steps.check-published.outputs.ALREADY_PUBLISHED != 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.PACKAGE_VERSION }}"
          NPM_TAG="${{ steps.version.outputs.NPM_TAG }}"

          echo "Publishing ${PACKAGE_VERSION} with tag: ${NPM_TAG}"
          npm publish --tag "${NPM_TAG}" --registry "https://npm.pkg.github.com" --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPMRC_GITHUB_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPMRC_DEFAULT_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_REGISTRY_URL: "https://npm.pkg.github.com"

      - name: Comment on PR with package info
        # Only comment for same-repo PRs (forked PRs can't publish)
        if: github.event_name == 'pull_request' && steps.check-published.outputs.ALREADY_PUBLISHED != 'true' && github.event.pull_request.head.repo.full_name == github.repository
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: npm-github
          message: |
            ## ðŸ“¦ NPM Package Published to GitHub Packages (Staging)

            | Property | Value |
            |----------|-------|
            | **Version** | `${{ steps.version.outputs.PACKAGE_VERSION }}` |
            | **Tag** | `${{ steps.version.outputs.NPM_TAG }}` |
            | **Registry** | npm.pkg.github.com |

            ### Install
            ```bash
            npm install @oleksandrkucherenko/mcp-obsidian@${{ steps.version.outputs.NPM_TAG }} --registry=https://npm.pkg.github.com
            ```

            > ðŸ’¡ This is a staging build (commit: `${{ github.event.pull_request.head.sha }}`)

      - name: GitHub Packages Publish Summary
        if: always()
        run: |
          echo "## GitHub Packages Publish Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-published.outputs.ALREADY_PUBLISHED }}" == "true" ]; then
            echo ":white_check_mark: **Skipped** - Version ${{ steps.version.outputs.PACKAGE_VERSION }} already exists in GitHub Packages" >> $GITHUB_STEP_SUMMARY
          else
            echo ":white_check_mark: **Published** - Version ${{ steps.version.outputs.PACKAGE_VERSION }} published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Registry | https://npm.pkg.github.com |" >> $GITHUB_STEP_SUMMARY
            echo "| Package | @oleksandrkucherenko/mcp-obsidian |" >> $GITHUB_STEP_SUMMARY
            echo "| Version | ${{ steps.version.outputs.PACKAGE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Tag | ${{ steps.version.outputs.NPM_TAG }} |" >> $GITHUB_STEP_SUMMARY
          fi
