name: Website

on:
  release:
    types: [created]
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (optional)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Bun with cache
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ] && [ "${{ github.ref }}" == "refs/tags/"* ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Run Docker Compose
        id: compose
        run: |
          docker compose -f ./docker-compose.test.yaml build
          docker compose -f ./docker-compose.test.yaml up -d

      - name: Wait for services to be healthy
        run: |
          timeout 300 bash -c 'until docker compose -f ./docker-compose.test.yaml ps --format json | jq -s "any(.Health == \"healthy\")" | grep -q true; do sleep 5; done'
        continue-on-error: true

      - name: Collect Screenshots
        run: |
          SCR_CONTAINER_NAME="obsidian" ./dockerize/ci.screenshot_obsidian.sh || true
        continue-on-error: true

      - name: Collect Docker Compose Logs
        if: always()
        run: |
          docker compose -f ./docker-compose.test.yaml logs --no-color > compose-logs.txt
          cat compose-logs.txt
        continue-on-error: true

      - name: Stop Docker Compose
        if: always()
        run: |
          docker compose -f ./docker-compose.test.yaml down
        continue-on-error: true

      - name: Upload reports (logs, screenshots, etc.)
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ci-reports
          path: |
            compose-logs.txt
            reports/**
          if-no-files-found: warn
          retention-days: 7

      - name: Copy screenshots to docs directory
        run: |
          mkdir -p docs
          if [ -d "reports/screenshots" ]; then
            cp -r reports/screenshots/* docs/ 2>/dev/null || true
          fi
        continue-on-error: true

      - name: Build static website
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          VERSION="${{ steps.version.outputs.version }}" \
          ./scripts/web.build.sh

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: screenshots-${{ github.run_id }}
          path: reports/screenshots/**/*
          if-no-files-found: warn
          retention-days: 30

      - name: Upload screenshots to branch (PR only)
        if: github.event_name == 'pull_request'
        id: upload_screenshots
        continue-on-error: true
        run: |
          # Check if we have screenshots
          if [ ! -d "reports/screenshots" ] || [ -z "$(ls -A reports/screenshots 2>/dev/null)" ]; then
            echo "No screenshots to upload"
            echo "has_screenshots=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_screenshots=true" >> $GITHUB_OUTPUT

          # Setup git for pushing to screenshots branch
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_DIR="pr-${PR_NUMBER}"
          SCREENSHOTS_BRANCH="screenshots"

          # Save screenshots to temp location
          TEMP_SCREENSHOTS=$(mktemp -d)
          cp -r reports/screenshots/* "$TEMP_SCREENSHOTS/"

          # Fetch or create screenshots branch
          git fetch origin "${SCREENSHOTS_BRANCH}:${SCREENSHOTS_BRANCH}" 2>/dev/null || true

          # Stash any changes and switch to screenshots branch
          git stash --include-untracked 2>/dev/null || true

          if git show-ref --verify --quiet "refs/heads/${SCREENSHOTS_BRANCH}"; then
            git checkout "${SCREENSHOTS_BRANCH}"
          else
            git checkout --orphan "${SCREENSHOTS_BRANCH}"
            git rm -rf . 2>/dev/null || true
            echo "# Screenshots Branch" > README.md
            echo "This branch contains screenshots from CI runs for PR previews." >> README.md
            git add README.md
            git commit -m "Initialize screenshots branch"
          fi

          # Create/update PR directory
          rm -rf "${PR_DIR}" 2>/dev/null || true
          mkdir -p "${PR_DIR}"
          cp -r "$TEMP_SCREENSHOTS"/* "${PR_DIR}/"

          # Generate image list for comment
          IMAGE_LIST=""
          for img in "${PR_DIR}"/*.png "${PR_DIR}"/*.jpg 2>/dev/null; do
            if [ -f "$img" ]; then
              filename=$(basename "$img")
              IMAGE_LIST="${IMAGE_LIST}${filename}\n"
            fi
          done
          echo -e "$IMAGE_LIST" > "${PR_DIR}/images.txt"

          # Commit and push
          git add "${PR_DIR}"
          git commit -m "Screenshots for PR #${PR_NUMBER} (run ${{ github.run_id }})" || echo "No changes to commit"
          git push origin "${SCREENSHOTS_BRANCH}"

          # Output image URLs for comment
          REPO="${{ github.repository }}"
          echo "screenshots_url=https://raw.githubusercontent.com/${REPO}/${SCREENSHOTS_BRANCH}/${PR_DIR}" >> $GITHUB_OUTPUT
          echo "pr_dir=${PR_DIR}" >> $GITHUB_OUTPUT

          # Return to original branch
          git checkout - 2>/dev/null || true
          git stash pop 2>/dev/null || true

      - name: Generate screenshot markdown
        if: github.event_name == 'pull_request' && steps.upload_screenshots.outputs.has_screenshots == 'true'
        id: screenshot_markdown
        run: |
          SCREENSHOTS_URL="${{ steps.upload_screenshots.outputs.screenshots_url }}"
          PR_DIR="${{ steps.upload_screenshots.outputs.pr_dir }}"
          REPO="${{ github.repository }}"
          SCREENSHOTS_BRANCH="screenshots"

          # Build markdown with images
          MARKDOWN="## ðŸ–¼ï¸ Obsidian Screenshots\n\n"
          MARKDOWN+="Screenshots from CI run [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n"

          # Fetch the images list from the screenshots branch
          git fetch origin "${SCREENSHOTS_BRANCH}:${SCREENSHOTS_BRANCH}" 2>/dev/null || true

          # Get list of images
          IMAGES=$(git show "${SCREENSHOTS_BRANCH}:${PR_DIR}/images.txt" 2>/dev/null || echo "")

          if [ -n "$IMAGES" ]; then
            MARKDOWN+="<details>\n<summary>Click to expand screenshots</summary>\n\n"
            while IFS= read -r img; do
              if [ -n "$img" ]; then
                MARKDOWN+="### ${img}\n"
                MARKDOWN+="![${img}](${SCREENSHOTS_URL}/${img})\n\n"
              fi
            done <<< "$IMAGES"
            MARKDOWN+="</details>\n"
          else
            MARKDOWN+="_No screenshots captured_\n"
          fi

          MARKDOWN+="\n> ðŸ“¸ Commit: \`${{ github.event.pull_request.head.sha }}\`"

          # Output markdown (escape for GitHub Actions)
          echo "markdown<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MARKDOWN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment with screenshot preview (PR only)
        if: github.event_name == 'pull_request' && steps.upload_screenshots.outputs.has_screenshots == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        continue-on-error: true
        with:
          header: screenshots
          message: ${{ steps.screenshot_markdown.outputs.markdown }}

      - name: Comment with no screenshots (PR only)
        if: github.event_name == 'pull_request' && steps.upload_screenshots.outputs.has_screenshots != 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        continue-on-error: true
        with:
          header: screenshots
          message: |
            ## ðŸ–¼ï¸ Obsidian Screenshots

            _No screenshots were captured in this run._

            > ðŸ“¸ Commit: `${{ github.event.pull_request.head.sha }}`

      - name: Add annotation with screenshot preview link
        if: github.event_name != 'pull_request'
        run: |
          echo "::notice title=CI Screenshot Preview::View screenshots at https://mcp-obsidian.artfulbits.se/${{ github.run_id }}/"

      - name: Setup Pages
        if: github.event_name != 'pull_request'
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        if: github.event_name != 'pull_request'
        uses: actions/deploy-pages@v4
