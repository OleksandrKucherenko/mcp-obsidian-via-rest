name: Screenshots VNC Obsidian GUI

on:
  release:
    types: [created]
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (optional)'
        required: false
        type: string

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  screenshots:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
      pages: write
      id-token: write
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run Docker Compose
        id: compose
        uses: hoverkraft-tech/compose-action@v2.2.0
        continue-on-error: true
        with:
          compose-file: ./docker-compose.test.yaml

      - name: Collect Docker Compose Logs
        shell: bash
        continue-on-error: true
        run: |
          # or: docker logs $(docker ps -aq) > compose-logs.txt
          docker compose -f ./docker-compose.test.yaml logs --no-color > compose-logs.txt
          # print to job log
          cat compose-logs.txt
          
      - name: Save version for gh-pages
        shell: bash
        continue-on-error: true
        run: |
          # Create version.json for gh-pages static version
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          mkdir -p reports
          echo "{\"version\": \"${PACKAGE_VERSION}\", \"updated\": \"$(date -Iseconds +%Y-%m-%dT%H:%M:%SZ)\"}" > reports/version.json
          
      - name: Collect Screenshots (only on failure)
        if: steps.compose.outcome == 'failure'
        shell: bash
        continue-on-error: true
        run: |
          # force docker to run VNC Obsidian container for making possible screenshots
          docker compose -f ./docker-compose.test.yaml up obsidian -d
          # try to capture screenshots
          SCR_CONTAINER_NAME="obsidian" ./dockerize/ci_screenshot_obsidian_gui.sh || true
          # stop VNC Obsidian container
          docker compose -f ./docker-compose.test.yaml down obsidian

      - name: Collect Screenshots (only on success)
        if: steps.compose.outcome == 'success'
        shell: bash
        continue-on-error: true
        run: |
          # try to capture screenshots
          SCR_CONTAINER_NAME="obsidian" ./dockerize/ci_screenshot_obsidian_gui.sh || true

      - name: Upload reports (logs, screenshots, etc.)
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ci-reports
          path: |
            compose-logs.txt
            reports/**
          if-no-files-found: warn
          retention-days: 7

      - name: Save version for gh-pages
        shell: bash
        continue-on-error: true
        run: |
          # Create version.json in docs directory for gh-pages static version
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          mkdir -p reports/docs
          echo "{\"version\": \"${PACKAGE_VERSION}\", \"updated\": \"$(date -Iseconds +%Y-%m-%dT%H:%M:%SZ)\"}" > reports/docs/version.json
          
      - name: Collect Screenshots (only on failure)
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./reports/screenshots
          destination_dir: ./docs/${{ github.run_id }}

      - name: Comment with screenshot preview
        uses: marocchino/sticky-pull-request-comment@v2
        continue-on-error: true
        with:
          message: |
            üñºÔ∏è [CI Screenshot Preview](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_id }}/)

      - name: Add annotation with screenshot preview link
        shell: bash
        run: |
          echo "::notice title=CI Screenshot Preview::View screenshots https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_id }}/"
